# ğŸ”§ Miniverse å·¥å…·è…³æœ¬

æœ¬ç›®éŒ„åŒ…å«ç”¨æ–¼éƒ¨ç½²ã€ç¶­è­·å’Œé™¤éŒ¯çš„å„ç¨®å·¥å…·è…³æœ¬ã€‚

---

## ğŸ“‚ ç›®éŒ„çµæ§‹

```
scripts/
â”œâ”€â”€ deployment/     # éƒ¨ç½²ç›¸é—œè…³æœ¬
â”œâ”€â”€ maintenance/    # ç¶­è­·ç›¸é—œè…³æœ¬
â””â”€â”€ debugging/      # é™¤éŒ¯ç›¸é—œè…³æœ¬
```

---

## ğŸš€ éƒ¨ç½²è…³æœ¬ (deployment/)

### update-and-deploy.sh

**ç”¨é€”**: è‡ªå‹•æ›´æ–°ä»£ç¢¼ä¸¦éƒ¨ç½²æ‡‰ç”¨

**ä½¿ç”¨æ–¹æ³•**:
```bash
# å®Œæ•´éƒ¨ç½²ï¼ˆå« Docker é‡å»ºï¼‰
./scripts/deployment/update-and-deploy.sh

# è·³é Docker é‡å»ºï¼ˆåƒ…æ›´æ–°ä»£ç¢¼ï¼‰
./scripts/deployment/update-and-deploy.sh --skip-build
```

**åŠŸèƒ½**:
- è‡ªå‹•å¾ GitHub æ‹‰å–æœ€æ–°ä»£ç¢¼
- æš«å­˜å’Œæ¢å¾©æœ¬åœ°æ›´æ”¹
- å¯é¸çš„ Docker é¡åƒé‡å»º
- é‡å•Ÿå®¹å™¨å’Œæœå‹™
- é©—è­‰éƒ¨ç½²ç‹€æ…‹

**é©ç”¨å ´æ™¯**:
- æ—¥å¸¸ä»£ç¢¼æ›´æ–°
- ä¿®å¾© Bug å¾Œçš„å¿«é€Ÿéƒ¨ç½²
- é…ç½®æ–‡ä»¶æ›´æ–°

---

### fix-permissions.sh

**ç”¨é€”**: ä¿®å¾© Docker å®¹å™¨èˆ‡ Git ä¹‹é–“çš„æ¬Šé™è¡çª

**ä½¿ç”¨æ–¹æ³•**:
```bash
# åœ¨ EC2 æˆ–æœå‹™å™¨ä¸ŠåŸ·è¡Œ
sudo ./scripts/deployment/fix-permissions.sh
```

**åŠŸèƒ½**:
- ä¿®æ­£ä¸»æ©Ÿæ–‡ä»¶æ‰€æœ‰æ¬Š
- é…ç½® Git å¿½ç•¥æ¬Šé™è®Šæ›´ (`core.fileMode = false`)
- æ¸…ç†å’ŒåŒæ­¥ä»£ç¢¼
- è¨­ç½®è…³æœ¬åŸ·è¡Œæ¬Šé™

**é©ç”¨å ´æ™¯**:
- Git æ“ä½œå‡ºç¾æ¬Šé™éŒ¯èª¤
- Docker å®¹å™¨ä¿®æ”¹äº†æ–‡ä»¶æ¬Šé™
- é¦–æ¬¡éƒ¨ç½²ç’°å¢ƒè¨­ç½®

**å¸¸è¦‹éŒ¯èª¤ä¿®å¾©**:
```
error: unable to unlink old 'storage/app/.gitignore': Permission denied
fatal: Could not reset index file to revision 'HEAD'
```

---

## ğŸ”§ ç¶­è­·è…³æœ¬ (maintenance/)

### disk-cleanup.sh

**ç”¨é€”**: è‡ªå‹•åŒ–ç£ç›¤ç©ºé–“æ¸…ç†

**ä½¿ç”¨æ–¹æ³•**:
```bash
# äº’å‹•æ¨¡å¼ï¼ˆæ¨è–¦ï¼‰
./scripts/maintenance/disk-cleanup.sh

# è‡ªå‹•æ¨¡å¼ï¼ˆè·³éç¢ºèªï¼‰
./scripts/maintenance/disk-cleanup.sh --auto
```

**æ¸…ç†é …ç›®**:
1. **Docker è³‡æº**
   - åœæ­¢çš„å®¹å™¨
   - æœªä½¿ç”¨çš„é¡åƒ
   - æ‡¸æ›çš„å·
   - æ§‹å»ºå¿«å–

2. **Laravel è‡¨æ™‚æ–‡ä»¶**
   - `storage/app/temp/` ä¸‹çš„æ–‡ä»¶
   - è¶…é 1 å°æ™‚çš„è‡¨æ™‚å½±ç‰‡æ–‡ä»¶

3. **Laravel æ—¥èªŒ**
   - `storage/logs/` ä¸‹è¶…é 7 å¤©çš„æ—¥èªŒ

4. **Nginx å¿«å–**
   - `/var/cache/nginx/` çš„è‡¨æ™‚æ–‡ä»¶

5. **ç³»çµ±æ—¥èªŒ**
   - Journal æ—¥èªŒï¼ˆä¿ç•™æœ€è¿‘ 3 å¤©ï¼‰

**é©ç”¨å ´æ™¯**:
- ç£ç›¤ä½¿ç”¨ç‡è¶…é 80%
- "No space left on device" éŒ¯èª¤
- å®šæœŸç¶­è­·æ¸…ç†

**æ³¨æ„äº‹é …**:
- æœƒåˆªé™¤æ‰€æœ‰ Docker æœªä½¿ç”¨è³‡æº
- æœƒæ¸…é™¤è¶…é 1 å°æ™‚çš„è‡¨æ™‚æ–‡ä»¶
- å»ºè­°å…ˆå‚™ä»½é‡è¦è³‡æ–™

---

## ğŸ› é™¤éŒ¯è…³æœ¬ (debugging/)

### check-scheduler.sh

**ç”¨é€”**: æª¢æŸ¥ Laravel Scheduler é‹è¡Œç‹€æ…‹

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/debugging/check-scheduler.sh
```

**æª¢æŸ¥é …ç›®**:
1. Supervisor ç‹€æ…‹
2. å·²å®šç¾©çš„æ’ç¨‹ä»»å‹™åˆ—è¡¨
3. æ‰‹å‹•åŸ·è¡Œä¸€æ¬¡æ’ç¨‹
4. Supervisor æ—¥èªŒï¼ˆæœ€å¾Œ 50 è¡Œï¼‰
5. Laravel æ—¥èªŒï¼ˆæ’ç¨‹ç›¸é—œï¼‰

**è¼¸å‡ºç¤ºä¾‹**:
```
=========================================
  æª¢æŸ¥ Laravel Scheduler ç‹€æ…‹
=========================================

1. Supervisor ç‹€æ…‹ï¼š
-----------------------------------
laravel-scheduler:laravel-scheduler_00   RUNNING   pid 123, uptime 1:23:45

2. å·²å®šç¾©çš„æ’ç¨‹ä»»å‹™ï¼š
-----------------------------------
  analyze:document --source=CNN --storage=gcs --limit=10 .... Daily at 2:00 AM
  analyze:video --source=CNN --storage=gcs --limit=5 ....... Daily at 3:00 AM
  ...
```

**é©ç”¨å ´æ™¯**:
- æ’ç¨‹ä»»å‹™æ²’æœ‰åŸ·è¡Œ
- é©—è­‰æ’ç¨‹é…ç½®
- æ’ç¨‹é‹è¡Œç•°å¸¸

---

### check-supervisor.sh

**ç”¨é€”**: æª¢æŸ¥ Supervisor æœå‹™ç‹€æ…‹

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/debugging/check-supervisor.sh
```

**æª¢æŸ¥é …ç›®**:
1. å®¹å™¨æ—¥èªŒï¼ˆæœ€å¾Œ 50 è¡Œï¼‰
2. å®¹å™¨å…§é€²ç¨‹åˆ—è¡¨
3. Supervisor é…ç½®æ–‡ä»¶
4. Entrypoint è…³æœ¬
5. å˜—è©¦æ‰‹å‹•å•Ÿå‹• Supervisor

**é©ç”¨å ´æ™¯**:
- Supervisor ç„¡æ³•å•Ÿå‹•
- `unix:///var/run/supervisor.sock no such file` éŒ¯èª¤
- é€²ç¨‹ç®¡ç†ç•°å¸¸

**å¸¸è¦‹éŒ¯èª¤è¨ºæ–·**:
```
unix:///var/run/supervisor.sock no such file
â†’ Supervisor æœªå•Ÿå‹•ï¼Œæª¢æŸ¥ entrypoint.sh

Error: Format string ... is badly formatted
â†’ Supervisor é…ç½®æ–‡ä»¶èªæ³•éŒ¯èª¤
```

---

### check-gcs-proxy.sh

**ç”¨é€”**: æª¢æŸ¥ GCS ä»£ç†éŒ¯èª¤å’Œæ–‡ä»¶è¨ªå•

**ä½¿ç”¨æ–¹æ³•**:
```bash
./scripts/debugging/check-gcs-proxy.sh
```

**æª¢æŸ¥é …ç›®**:
1. Nginx éŒ¯èª¤æ—¥èªŒï¼ˆGCS ç›¸é—œï¼‰
2. Laravel æ—¥èªŒï¼ˆGCS ä»£ç†ç›¸é—œï¼‰
3. GCS é…ç½®
4. æ¸¬è©¦æ–‡ä»¶è¨ªå•

**è¼¸å‡ºç¤ºä¾‹**:
```
=========================================
  æª¢æŸ¥ GCS Proxy éŒ¯èª¤
=========================================

1. Nginx éŒ¯èª¤æ—¥èªŒï¼ˆæœ€å¾Œ 50 è¡Œï¼Œéæ¿¾ gcs-proxyï¼‰ï¼š
-----------------------------------
[error] 123#123: *456 upstream timed out (110: Connection timed out)

2. Laravel æ—¥èªŒï¼ˆGCS ç›¸é—œï¼Œæœ€å¾Œ 50 è¡Œï¼‰ï¼š
-----------------------------------
[2025-12-17 15:00:00] production.ERROR: [GcsProxyController] ç„¡æ³•é–‹å•Ÿæª”æ¡ˆä¸²æµ
```

**é©ç”¨å ´æ™¯**:
- GCS ä»£ç†è¿”å› 500 éŒ¯èª¤
- å½±ç‰‡æ’­æ”¾å¤±æ•—
- æ–‡ä»¶ä¸‹è¼‰å•é¡Œ

---

## ğŸ“‹ æœ€ä½³å¯¦è¸

### 1. å®šæœŸç¶­è­·

```bash
# æ¯é€±åŸ·è¡Œä¸€æ¬¡ç£ç›¤æ¸…ç†
./scripts/maintenance/disk-cleanup.sh

# æ¯æ—¥æª¢æŸ¥æ’ç¨‹ç‹€æ…‹
./scripts/debugging/check-scheduler.sh
```

### 2. éƒ¨ç½²å‰æª¢æŸ¥

```bash
# 1. æª¢æŸ¥æ’ç¨‹ç‹€æ…‹
./scripts/debugging/check-scheduler.sh

# 2. æª¢æŸ¥ç£ç›¤ç©ºé–“
df -h

# 3. åŸ·è¡Œéƒ¨ç½²
./scripts/deployment/update-and-deploy.sh --skip-build
```

### 3. æ•…éšœæ’æŸ¥æµç¨‹

```bash
# æ­¥é©Ÿ 1: æª¢æŸ¥ Supervisor
./scripts/debugging/check-supervisor.sh

# æ­¥é©Ÿ 2: æª¢æŸ¥æ’ç¨‹
./scripts/debugging/check-scheduler.sh

# æ­¥é©Ÿ 3: æª¢æŸ¥ GCSï¼ˆå¦‚æœç›¸é—œï¼‰
./scripts/debugging/check-gcs-proxy.sh

# æ­¥é©Ÿ 4: æª¢æŸ¥ç£ç›¤ç©ºé–“
df -h

# æ­¥é©Ÿ 5: å¦‚éœ€æ¸…ç†
./scripts/maintenance/disk-cleanup.sh
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **æ¬Šé™è¦æ±‚**
   - å¤§éƒ¨åˆ†è…³æœ¬éœ€è¦åœ¨æœå‹™å™¨ä¸ŠåŸ·è¡Œ
   - æŸäº›è…³æœ¬å¯èƒ½éœ€è¦ `sudo` æ¬Šé™ï¼ˆå¦‚ `fix-permissions.sh`ï¼‰

2. **åŸ·è¡Œç’°å¢ƒ**
   - ç¢ºä¿åœ¨ `web-miniverse` é …ç›®æ ¹ç›®éŒ„åŸ·è¡Œ
   - ç¢ºä¿ Docker Compose æœå‹™æ­£åœ¨é‹è¡Œ

3. **å‚™ä»½å»ºè­°**
   - åŸ·è¡Œæ¸…ç†è…³æœ¬å‰ï¼Œå»ºè­°å…ˆå‚™ä»½é‡è¦è³‡æ–™
   - ç‰¹åˆ¥æ˜¯ `disk-cleanup.sh` æœƒåˆªé™¤å¤§é‡æ–‡ä»¶

4. **æ—¥èªŒæŸ¥çœ‹**
   - æ‰€æœ‰è…³æœ¬åŸ·è¡Œå¾Œå»ºè­°æŸ¥çœ‹ç›¸é—œæ—¥èªŒ
   - ç¢ºèªæ“ä½œæ˜¯å¦æˆåŠŸå®Œæˆ

---

## ğŸ†˜ ç²å–å¹«åŠ©

å¦‚æœé‡åˆ°å•é¡Œï¼š

1. æŸ¥çœ‹è…³æœ¬å…§çš„è¨»é‡‹å’Œèªªæ˜
2. æŸ¥çœ‹ä¸» README çš„å¸¸è¦‹å•é¡Œéƒ¨åˆ†
3. æŸ¥çœ‹ `docs/` ç›®éŒ„ä¸‹çš„ç›¸é—œæ–‡æª”
4. è¯çµ¡é …ç›®ç¶­è­·åœ˜éšŠ

---

<div align="center">
  <sub>ğŸ’¡ æç¤ºï¼šæ‰€æœ‰è…³æœ¬éƒ½åŒ…å«è©³ç´°çš„è¼¸å‡ºå’ŒéŒ¯èª¤æç¤º</sub>
</div>

