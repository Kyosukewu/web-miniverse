# Docker æ„å»ºé—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸ”´ å¸¸è§é”™è¯¯ï¼šNo space left on device

### é”™è¯¯ä¿¡æ¯

```
tar: ext/soap/tests/bugs/bug30175.wsdl: Cannot write: No space left on device
tar: ext/soap/tests/bugs/bug30799.phpt: Cannot write: No space left on device
...
tar: Exiting with failure status due to previous errors
```

### é—®é¢˜åŸå› 

å³ä½¿æ‚¨æ²¡æœ‰ä¿®æ”¹ Dockerfile æˆ–ç›¸å…³ä»£ç ï¼ŒDocker æ„å»ºä»ç„¶å¯èƒ½å¤±è´¥ï¼ŒåŸå› åŒ…æ‹¬ï¼š

#### 1. **Docker æ„å»ºç¼“å­˜ç´¯ç§¯**

Docker ä¼šç¼“å­˜æ¯ä¸€å±‚çš„æ„å»ºç»“æœã€‚å³ä½¿ä»£ç æ²¡æœ‰å˜åŒ–ï¼Œä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´ç¼“å­˜ç´¯ç§¯ï¼š

- **å¤šæ¬¡æ„å»ºå°è¯•**ï¼šæ¯æ¬¡å¤±è´¥çš„æ„å»ºéƒ½ä¼šç•™ä¸‹ç¼“å­˜
- **åŸºç¡€é•œåƒæ›´æ–°**ï¼š`php:8.4-fpm` åŸºç¡€é•œåƒå¯èƒ½è¢«æ›´æ–°
- **ä¾èµ–åŒ…æ›´æ–°**ï¼š`apt-get update` å¯èƒ½è·å–åˆ°æ–°çš„åŒ…ç‰ˆæœ¬
- **æ„å»ºä¸Šä¸‹æ–‡å˜åŒ–**ï¼šå³ä½¿ä»£ç æ²¡å˜ï¼Œæ–‡ä»¶æ—¶é—´æˆ³å˜åŒ–ä¹Ÿä¼šå½±å“ç¼“å­˜

#### 2. **ç£ç›˜ç©ºé—´ä¸è¶³**

Docker æ„å»ºè¿‡ç¨‹éœ€è¦å¤§é‡ä¸´æ—¶ç©ºé—´ï¼š

- **åŸºç¡€é•œåƒ**ï¼š`php:8.4-fpm` çº¦ 400-500MB
- **ç³»ç»Ÿä¾èµ–**ï¼šapt åŒ…çº¦ 200-300MB
- **PHP æ‰©å±•ç¼–è¯‘**ï¼šç¼–è¯‘è¿‡ç¨‹éœ€è¦ 500MB-1GB ä¸´æ—¶ç©ºé—´
- **æ„å»ºç¼“å­˜**ï¼šç´¯ç§¯çš„ç¼“å­˜å¯èƒ½å ç”¨æ•° GB

#### 3. **Docker æ„å»ºä¸Šä¸‹æ–‡è¿‡å¤§**

å³ä½¿ä½¿ç”¨ `.dockerignore`ï¼Œå¦‚æœé¡¹ç›®ä¸­æœ‰å¤§æ–‡ä»¶ï¼Œæ„å»ºä¸Šä¸‹æ–‡ä»ç„¶å¯èƒ½å¾ˆå¤§ï¼š

- è§†é¢‘æ–‡ä»¶ï¼ˆ.mp4, .mov ç­‰ï¼‰
- å¤§å‹æ—¥å¿—æ–‡ä»¶
- node_modulesï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- vendor ç›®å½•ï¼ˆå¦‚æœæœªæ­£ç¡®æ’é™¤ï¼‰

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæ¸…ç† Docker ç©ºé—´ï¼ˆæ¨èï¼Œå¿«é€Ÿè§£å†³ï¼‰

```bash
# ä½¿ç”¨æä¾›çš„æ¸…ç†è„šæœ¬
./scripts/docker/fix-docker-space.sh

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
# 1. æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆæœ€é‡è¦ï¼‰
docker builder prune -af

# 2. æ¸…ç†æœªä½¿ç”¨çš„é•œåƒå’Œå®¹å™¨
docker system prune -af

# 3. æŸ¥çœ‹æ¸…ç†åçš„ç©ºé—´
docker system df
```

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ— ç¼“å­˜æ„å»ºï¼ˆä¸´æ—¶è§£å†³ï¼‰

```bash
# å®Œå…¨ç¦ç”¨ç¼“å­˜é‡æ–°æ„å»º
docker compose build --no-cache app

# æˆ–åªæ¸…ç†ç‰¹å®šå±‚çš„ç¼“å­˜
docker compose build --pull app
```

### æ–¹æ¡ˆ 3ï¼šä¼˜åŒ– Dockerfileï¼ˆé•¿æœŸè§£å†³ï¼‰

å·²ä¼˜åŒ–çš„ Dockerfile æ”¹è¿›ï¼š

1. **åˆå¹¶ RUN æŒ‡ä»¤**ï¼šå‡å°‘é•œåƒå±‚æ•°
2. **ä½¿ç”¨ --no-install-recommends**ï¼šå‡å°‘ä¸å¿…è¦çš„åŒ…
3. **æ¸…ç† apt ç¼“å­˜**ï¼š`rm -rf /var/lib/apt/lists/* && apt-get clean`
4. **ä½¿ç”¨ --no-cache-dir**ï¼špip ä¸ç¼“å­˜åŒ…
5. **åˆ é™¤ PHP æºç **ï¼š`docker-php-source delete` é‡Šæ”¾ç©ºé—´

### æ–¹æ¡ˆ 4ï¼šæ£€æŸ¥ç£ç›˜ç©ºé—´

```bash
# æ£€æŸ¥ç³»ç»Ÿç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ Docker ä½¿ç”¨çš„ç©ºé—´
docker system df

# æŸ¥çœ‹å ç”¨ç©ºé—´æœ€å¤§çš„é•œåƒ
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | sort -k3 -h -r | head -10

# æŸ¥çœ‹å ç”¨ç©ºé—´æœ€å¤§çš„å®¹å™¨
docker ps -a --format "table {{.Names}}\t{{.Size}}" | sort -k2 -h -r | head -10
```

### æ–¹æ¡ˆ 5ï¼šå¢åŠ  Docker ç£ç›˜ç©ºé—´é™åˆ¶

å¦‚æœä½¿ç”¨ Docker Desktopï¼š

1. æ‰“å¼€ Docker Desktop
2. è¿›å…¥ Settings â†’ Resources â†’ Advanced
3. å¢åŠ  Disk image sizeï¼ˆä¾‹å¦‚ä» 64GB å¢åŠ åˆ° 128GBï¼‰

å¦‚æœä½¿ç”¨ Linuxï¼š

```bash
# æ£€æŸ¥ Docker æ•°æ®ç›®å½•
docker info | grep "Docker Root Dir"

# å¦‚æœç©ºé—´ä¸è¶³ï¼Œå¯ä»¥ç§»åŠ¨ Docker æ•°æ®ç›®å½•åˆ°æ›´å¤§çš„åˆ†åŒº
# ï¼ˆéœ€è¦åœæ­¢ Docker æœåŠ¡ï¼‰
```

## ğŸ“Š ä¸ºä»€ä¹ˆæ²¡æœ‰å˜åŠ¨å´ä¼šéƒ¨ç½²å‡ºé”™ï¼Ÿ

### åŸå› åˆ†æ

#### 1. **Docker æ„å»ºç¼“å­˜æœºåˆ¶**

Docker ä½¿ç”¨**åˆ†å±‚ç¼“å­˜**æœºåˆ¶ï¼š

```
Layer 1: FROM php:8.4-fpm          â† å¦‚æœåŸºç¡€é•œåƒæ›´æ–°ï¼Œç¼“å­˜å¤±æ•ˆ
Layer 2: RUN apt-get update        â† å¦‚æœåŒ…åˆ—è¡¨æ›´æ–°ï¼Œç¼“å­˜å¤±æ•ˆ
Layer 3: RUN pip3 install yt-dlp  â† å¦‚æœåŒ…ç‰ˆæœ¬æ›´æ–°ï¼Œç¼“å­˜å¤±æ•ˆ
Layer 4: RUN docker-php-ext-install â† å¦‚æœ PHP æºç å˜åŒ–ï¼Œç¼“å­˜å¤±æ•ˆ
```

**å³ä½¿æ‚¨çš„ä»£ç æ²¡å˜**ï¼Œä»¥ä¸‹æƒ…å†µä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼š

- åŸºç¡€é•œåƒ `php:8.4-fpm` è¢«æ›´æ–°
- apt ä»“åº“ä¸­çš„åŒ…ç‰ˆæœ¬æ›´æ–°
- pip ä»“åº“ä¸­çš„åŒ…ç‰ˆæœ¬æ›´æ–°
- Docker æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶æ—¶é—´æˆ³å˜åŒ–

#### 2. **ç´¯ç§¯çš„æ„å»ºå¤±è´¥**

æ¯æ¬¡æ„å»ºå¤±è´¥éƒ½ä¼šï¼š

- ç•™ä¸‹éƒ¨åˆ†æ„å»ºçš„å±‚
- å ç”¨ç£ç›˜ç©ºé—´
- å¯èƒ½æŸåç¼“å­˜

å¤šæ¬¡å¤±è´¥åï¼Œå³ä½¿ä»£ç æ²¡å˜ï¼Œä¹Ÿå¯èƒ½å› ä¸ºï¼š
- ç£ç›˜ç©ºé—´ä¸è¶³
- ç¼“å­˜æŸå
- ä¸´æ—¶æ–‡ä»¶ç´¯ç§¯

#### 3. **ç³»ç»Ÿèµ„æºå˜åŒ–**

- **ç£ç›˜ç©ºé—´**ï¼šå…¶ä»–ç¨‹åºå ç”¨ç©ºé—´
- **å†…å­˜ä¸è¶³**ï¼šç¼–è¯‘ PHP æ‰©å±•éœ€è¦å¤§é‡å†…å­˜
- **inode è€—å°½**ï¼šå¤§é‡å°æ–‡ä»¶å¯¼è‡´ inode ä¸è¶³

## ğŸ› ï¸ é¢„é˜²æªæ–½

### 1. å®šæœŸæ¸…ç† Docker ç©ºé—´

```bash
# æ·»åŠ åˆ° crontabï¼ˆæ¯å‘¨æ¸…ç†ä¸€æ¬¡ï¼‰
0 2 * * 0 docker system prune -af --filter "until=168h"
```

### 2. ç›‘æ§ç£ç›˜ç©ºé—´

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat > /usr/local/bin/check-docker-space.sh << 'EOF'
#!/bin/bash
THRESHOLD=80  # ç£ç›˜ä½¿ç”¨ç‡é˜ˆå€¼ï¼ˆ%ï¼‰
USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')

if [ "$USAGE" -gt "$THRESHOLD" ]; then
    echo "è­¦å‘Šï¼šç£ç›˜ä½¿ç”¨ç‡ ${USAGE}% è¶…è¿‡é˜ˆå€¼ ${THRESHOLD}%"
    docker system prune -f
fi
EOF

chmod +x /usr/local/bin/check-docker-space.sh
```

### 3. ä¼˜åŒ–æ„å»ºæµç¨‹

```bash
# åœ¨æ„å»ºå‰è‡ªåŠ¨æ¸…ç†
docker builder prune -af --filter "until=24h"
docker compose build app
```

### 4. ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼ˆå¦‚æœé€‚ç”¨ï¼‰

å¯¹äºå¤§å‹é¡¹ç›®ï¼Œè€ƒè™‘ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºæ¥å‡å°‘æœ€ç»ˆé•œåƒå¤§å°ã€‚

## ğŸ“ æ„å»ºæœ€ä½³å®è·µ

### 1. æ„å»ºå‰æ£€æŸ¥

```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ Docker ç©ºé—´
docker system df

# å¦‚æœç©ºé—´ä¸è¶³ï¼Œå…ˆæ¸…ç†
docker builder prune -af
```

### 2. ä½¿ç”¨ .dockerignore

ç¡®ä¿ `.dockerignore` æ­£ç¡®é…ç½®ï¼Œæ’é™¤ï¼š
- å¤§å‹åª’ä½“æ–‡ä»¶
- æ—¥å¿—æ–‡ä»¶
- ä¸´æ—¶æ–‡ä»¶
- node_modules
- vendorï¼ˆå¦‚æœä¸åœ¨æ„å»ºæ—¶å®‰è£…ï¼‰

### 3. åˆ†é˜¶æ®µæ„å»º

å¦‚æœæ„å»ºç»å¸¸å¤±è´¥ï¼Œå¯ä»¥åˆ†é˜¶æ®µæ„å»ºï¼š

```bash
# åªæ„å»ºåˆ°æŸä¸ªé˜¶æ®µ
docker compose build --target <stage> app
```

### 4. ä½¿ç”¨æ„å»ºå‚æ•°

```bash
# ä½¿ç”¨æ„å»ºå‚æ•°æ§åˆ¶æ„å»ºè¡Œä¸º
docker compose build \
  --build-arg BUILDKIT_INLINE_CACHE=1 \
  --build-arg DOCKER_BUILDKIT=1 \
  app
```

## ğŸ” æ•…éšœæ’æŸ¥æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥ç£ç›˜ç©ºé—´

```bash
df -h
```

å¦‚æœä½¿ç”¨ç‡ > 90%ï¼Œéœ€è¦æ¸…ç†ã€‚

### æ­¥éª¤ 2ï¼šæ£€æŸ¥ Docker ç©ºé—´

```bash
docker system df
```

é‡ç‚¹å…³æ³¨ï¼š
- **Build Cache**ï¼šåº”è¯¥å®šæœŸæ¸…ç†
- **Images**ï¼šåˆ é™¤æœªä½¿ç”¨çš„é•œåƒ
- **Containers**ï¼šåˆ é™¤åœæ­¢çš„å®¹å™¨

### æ­¥éª¤ 3ï¼šæ¸…ç†æ„å»ºç¼“å­˜

```bash
# æ¸…ç†æ‰€æœ‰æ„å»ºç¼“å­˜
docker builder prune -af

# æˆ–åªæ¸…ç†è¶…è¿‡ 24 å°æ—¶çš„ç¼“å­˜
docker builder prune -af --filter "until=24h"
```

### æ­¥éª¤ 4ï¼šé‡æ–°æ„å»º

```bash
# ä½¿ç”¨æ— ç¼“å­˜æ„å»ºï¼ˆå¦‚æœæ¸…ç†åä»ç„¶å¤±è´¥ï¼‰
docker compose build --no-cache app

# æˆ–ä½¿ç”¨æ‹‰å–æœ€æ–°åŸºç¡€é•œåƒ
docker compose build --pull app
```

### æ­¥éª¤ 5ï¼šæ£€æŸ¥æ„å»ºæ—¥å¿—

```bash
# æŸ¥çœ‹è¯¦ç»†çš„æ„å»ºæ—¥å¿—
docker compose build --progress=plain app 2>&1 | tee build.log

# æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯
grep -i "error\|fail\|space" build.log
```

## ğŸ“Š ç©ºé—´å ç”¨åˆ†æ

### å…¸å‹ç©ºé—´å ç”¨

| é¡¹ç›® | å¤§å° | è¯´æ˜ |
|------|------|------|
| php:8.4-fpm åŸºç¡€é•œåƒ | ~450MB | åŸºç¡€ PHP é•œåƒ |
| ç³»ç»Ÿä¾èµ–åŒ… | ~200MB | apt å®‰è£…çš„åŒ… |
| PHP æ‰©å±•ç¼–è¯‘ | ~300MB | ç¼–è¯‘åçš„æ‰©å±• |
| æ„å»ºç¼“å­˜ | 1-5GB | ç´¯ç§¯çš„æ„å»ºç¼“å­˜ |
| æœªä½¿ç”¨çš„é•œåƒ | 500MB-2GB | æ—§çš„é•œåƒç‰ˆæœ¬ |
| åœæ­¢çš„å®¹å™¨ | 100MB-500MB | åœæ­¢ä½†æœªåˆ é™¤çš„å®¹å™¨ |

### æ¸…ç†æ•ˆæœ

æ‰§è¡Œ `docker builder prune -af` åï¼Œé€šå¸¸å¯ä»¥é‡Šæ”¾ï¼š
- **æ„å»ºç¼“å­˜**ï¼š1-3GB
- **æ‚¬ç©ºé•œåƒ**ï¼š500MB-1GB
- **æ€»è®¡**ï¼š1.5-4GB

## âœ… å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# ä¸€é”®æ¸…ç†å’Œé‡å»º
docker builder prune -af && \
docker system prune -f && \
docker compose build --pull app
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Docker æ„å»ºæœ€ä½³å®è·µ](https://docs.docker.com/build/guide/)
- [Docker ç³»ç»Ÿæ¸…ç†](https://docs.docker.com/config/pruning/)
- [Dockerfile ä¼˜åŒ–æŒ‡å—](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)

## ğŸ†˜ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

1. **æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—**ï¼š
   ```bash
   dmesg | grep -i "out of memory\|no space"
   ```

2. **æ£€æŸ¥ inode ä½¿ç”¨**ï¼š
   ```bash
   df -i
   ```

3. **æ£€æŸ¥ Docker æ—¥å¿—**ï¼š
   ```bash
   journalctl -u docker.service | tail -50
   ```

4. **è”ç³»ç³»ç»Ÿç®¡ç†å‘˜**ï¼šå¯èƒ½éœ€è¦å¢åŠ ç£ç›˜ç©ºé—´æˆ–è°ƒæ•´ Docker é…ç½®

## æ€»ç»“

**ä¸ºä»€ä¹ˆæ²¡æœ‰å˜åŠ¨å´ä¼šéƒ¨ç½²å‡ºé”™ï¼Ÿ**

1. âœ… Docker æ„å»ºç¼“å­˜ç´¯ç§¯
2. âœ… åŸºç¡€é•œåƒæˆ–ä¾èµ–åŒ…æ›´æ–°
3. âœ… ç£ç›˜ç©ºé—´ä¸è¶³
4. âœ… ä¹‹å‰çš„æ„å»ºå¤±è´¥ç•™ä¸‹æ®‹ç•™

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. âœ… å®šæœŸæ¸…ç† Docker ç©ºé—´ï¼ˆæœ€é‡è¦ï¼‰
2. âœ… ä¼˜åŒ– Dockerfile å‡å°‘ç©ºé—´å ç”¨
3. âœ… ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
4. âœ… ä½¿ç”¨æ„å»ºæœ€ä½³å®è·µ

