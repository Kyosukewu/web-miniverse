# Docker ç©ºé—´é—®é¢˜è¯Šæ–­æŒ‡å—

## ğŸ” é—®é¢˜ç±»å‹

"No space left on device" é”™è¯¯å¯èƒ½ç”±ä¸¤ç§åŸå› å¼•èµ·ï¼š

1. **ä¸»æœºç£ç›˜ç©ºé—´ä¸è¶³** - æ•´ä¸ªç³»ç»Ÿç£ç›˜ç©ºé—´ä¸è¶³
2. **Docker ç©ºé—´ä¸è¶³** - Docker æ•°æ®ç›®å½•æ‰€åœ¨åˆ†åŒºç©ºé—´ä¸è¶³ï¼ˆæˆ– Docker Desktop ç£ç›˜é•œåƒé™åˆ¶ï¼‰

## ğŸ“Š å¿«é€Ÿè¯Šæ–­

### ä½¿ç”¨è¯Šæ–­è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œè¯Šæ–­è„šæœ¬
./scripts/docker/diagnose-space.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š
- âœ… ä¸»æœºç£ç›˜ç©ºé—´
- âœ… Docker æ•°æ®ç›®å½•ç©ºé—´
- âœ… Docker èµ„æºä½¿ç”¨æƒ…å†µ
- âœ… Inode ä½¿ç”¨æƒ…å†µ
- âœ… Docker Desktop é…ç½®ï¼ˆå¦‚æœé€‚ç”¨ï¼‰

### æ‰‹åŠ¨æ£€æŸ¥å‘½ä»¤

```bash
# 1. æ£€æŸ¥ä¸»æœºç£ç›˜ç©ºé—´
df -h

# 2. æ£€æŸ¥ Docker æ•°æ®ç›®å½•æ‰€åœ¨åˆ†åŒº
docker info | grep "Docker Root Dir"
df -h $(docker info | grep "Docker Root Dir" | awk '{print $4}')

# 3. æ£€æŸ¥ Docker ç©ºé—´ä½¿ç”¨
docker system df

# 4. æ£€æŸ¥ inodeï¼ˆå¯èƒ½çš„åŸå› ï¼‰
df -i
```

## ğŸ”´ æƒ…å†µ 1ï¼šä¸»æœºç£ç›˜ç©ºé—´ä¸è¶³

### ç‰¹å¾

- `df -h /` æ˜¾ç¤ºæ ¹åˆ†åŒºä½¿ç”¨ç‡ > 90%
- æ‰€æœ‰åˆ†åŒºç©ºé—´éƒ½ç´§å¼ 
- ç³»ç»Ÿå…¶ä»–æ“ä½œä¹Ÿå¯èƒ½å¤±è´¥

### æ£€æŸ¥æ–¹æ³•

```bash
# æŸ¥çœ‹æ ¹åˆ†åŒºä½¿ç”¨ç‡
df -h / | awk 'NR==2 {print $5}'

# å¦‚æœæ˜¾ç¤º > 90%ï¼Œè¯´æ˜ä¸»æœºç©ºé—´ä¸è¶³
```

### è§£å†³æ–¹æ¡ˆ

#### 1. æ¸…ç†ç³»ç»Ÿæ—¥å¿—

```bash
# åªä¿ç•™æœ€è¿‘ 7 å¤©çš„æ—¥å¿—
sudo journalctl --vacuum-time=7d

# æˆ–é™åˆ¶æ—¥å¿—å¤§å°
sudo journalctl --vacuum-size=500M
```

#### 2. æ¸…ç† apt ç¼“å­˜

```bash
sudo apt-get clean
sudo apt-get autoremove -y
```

#### 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶

```bash
# æ¸…ç† /tmp ç›®å½•ï¼ˆè°¨æ…ï¼ï¼‰
sudo find /tmp -type f -atime +7 -delete

# æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
sudo rm -rf /var/tmp/*
```

#### 4. æŸ¥æ‰¾å¤§æ–‡ä»¶

```bash
# æŸ¥æ‰¾å ç”¨ç©ºé—´æœ€å¤§çš„ç›®å½•ï¼ˆå‰ 10 ä¸ªï¼‰
sudo du -h --max-depth=1 / | sort -h -r | head -10

# æŸ¥æ‰¾å¤§æ–‡ä»¶ï¼ˆ> 100MBï¼‰
sudo find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null | head -20
```

#### 5. è”ç³»ç³»ç»Ÿç®¡ç†å‘˜

å¦‚æœç©ºé—´çœŸçš„ä¸è¶³ï¼Œéœ€è¦ï¼š
- å¢åŠ ç£ç›˜å®¹é‡
- æŒ‚è½½é¢å¤–çš„ç£ç›˜
- è¿ç§»æ•°æ®åˆ°å…¶ä»–å­˜å‚¨

## ğŸ”µ æƒ…å†µ 2ï¼šDocker ç©ºé—´ä¸è¶³

### ç‰¹å¾

- ä¸»æœºç£ç›˜ç©ºé—´å……è¶³ï¼ˆ< 80%ï¼‰
- ä½† Docker æ„å»ºå¤±è´¥
- `docker system df` æ˜¾ç¤ºå¤§é‡ç¼“å­˜

### æ£€æŸ¥æ–¹æ³•

```bash
# æ£€æŸ¥ Docker æ•°æ®ç›®å½•æ‰€åœ¨åˆ†åŒº
DOCKER_ROOT=$(docker info | grep "Docker Root Dir" | awk '{print $4}')
df -h "$DOCKER_ROOT"

# æ£€æŸ¥ Docker èµ„æºä½¿ç”¨
docker system df
```

### è§£å†³æ–¹æ¡ˆ

#### 1. æ¸…ç† Docker æ„å»ºç¼“å­˜ï¼ˆæœ€é‡è¦ï¼‰

```bash
# æ¸…ç†æ‰€æœ‰æ„å»ºç¼“å­˜ï¼ˆé‡Šæ”¾ 1-3GBï¼‰
docker builder prune -af
```

#### 2. æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ

```bash
# æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼ˆé‡Šæ”¾ 500MB-2GBï¼‰
docker image prune -af
```

#### 3. æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨å’Œç½‘ç»œ

```bash
# æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨ã€ç½‘ç»œï¼ˆé‡Šæ”¾ 100MB-500MBï¼‰
docker system prune -af
```

#### 4. ä½¿ç”¨ç´§æ€¥æ¸…ç†è„šæœ¬

```bash
# ä¸€é”®æ¸…ç†æ‰€æœ‰ Docker èµ„æº
./scripts/docker/emergency-cleanup.sh
```

### Docker Desktop ç‰¹æ®Šæƒ…å†µ

å¦‚æœä½¿ç”¨ **Docker Desktop**ï¼ˆmacOS/Windowsï¼‰ï¼Œè¿˜æœ‰é¢å¤–çš„é™åˆ¶ï¼š

#### æ£€æŸ¥ Docker Desktop ç£ç›˜é•œåƒå¤§å°

1. æ‰“å¼€ Docker Desktop
2. è¿›å…¥ **Settings â†’ Resources â†’ Advanced**
3. æŸ¥çœ‹ **Disk image size**

#### å¢åŠ  Docker Desktop ç£ç›˜é•œåƒå¤§å°

1. æ‰“å¼€ Docker Desktop
2. è¿›å…¥ **Settings â†’ Resources â†’ Advanced**
3. å¢åŠ  **Disk image size**ï¼ˆä¾‹å¦‚ï¼šä» 32GB å¢åŠ åˆ° 64GB æˆ– 128GBï¼‰
4. ç‚¹å‡» **Apply & Restart**

**æ³¨æ„**ï¼š
- å¢åŠ ç£ç›˜é•œåƒå¤§å°éœ€è¦é‡å¯ Docker Desktop
- å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ¥è°ƒæ•´å¤§å°
- å»ºè®®è‡³å°‘è®¾ç½®ä¸º 64GB

## ğŸ” æƒ…å†µ 3ï¼šInode è€—å°½

### ç‰¹å¾

- ç£ç›˜ç©ºé—´å……è¶³
- ä½†åˆ›å»ºæ–‡ä»¶å¤±è´¥
- `df -i` æ˜¾ç¤º inode ä½¿ç”¨ç‡ > 90%

### æ£€æŸ¥æ–¹æ³•

```bash
# æ£€æŸ¥ inode ä½¿ç”¨æƒ…å†µ
df -i

# å¦‚æœæ˜¾ç¤º > 90%ï¼Œè¯´æ˜ inode è€—å°½
```

### è§£å†³æ–¹æ¡ˆ

```bash
# 1. æŸ¥æ‰¾å¤§é‡å°æ–‡ä»¶çš„ç›®å½•
sudo find / -xdev -type f | cut -d "/" -f 2 | sort | uniq -c | sort -n | tail -10

# 2. æ¸…ç† Docker æ—¥å¿—ï¼ˆå¸¸è§åŸå› ï¼‰
docker system prune -af

# 3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
sudo find /tmp -type f -delete

# 4. æ¸…ç†ç³»ç»Ÿæ—¥å¿—
sudo journalctl --vacuum-time=7d
```

## ğŸ“‹ è¯Šæ–­æµç¨‹

```
é‡åˆ° "No space left on device" é”™è¯¯
    â†“
è¿è¡Œè¯Šæ–­è„šæœ¬
./scripts/docker/diagnose-space.sh
    â†“
æ£€æŸ¥ç»“æœ
    â”œâ”€ ä¸»æœºç©ºé—´ä¸è¶³ (> 90%)
    â”‚   â””â”€ æ¸…ç†ä¸»æœºç£ç›˜ç©ºé—´
    â”‚
    â”œâ”€ Docker ç©ºé—´ä¸è¶³
    â”‚   â””â”€ æ¸…ç† Docker èµ„æº
    â”‚       â”œâ”€ docker builder prune -af
    â”‚       â”œâ”€ docker image prune -af
    â”‚       â””â”€ docker system prune -af
    â”‚
    â”œâ”€ Docker Desktop ç£ç›˜é•œåƒé™åˆ¶
    â”‚   â””â”€ å¢åŠ ç£ç›˜é•œåƒå¤§å°
    â”‚
    â””â”€ Inode è€—å°½
        â””â”€ åˆ é™¤å¤§é‡å°æ–‡ä»¶
```

## ğŸ¯ å¿«é€Ÿä¿®å¤å‘½ä»¤

### å¦‚æœæ˜¯ä¸»æœºç©ºé—´ä¸è¶³

```bash
# æ¸…ç†ç³»ç»Ÿæ—¥å¿—
sudo journalctl --vacuum-time=7d

# æ¸…ç† apt ç¼“å­˜
sudo apt-get clean && sudo apt-get autoremove -y

# æ£€æŸ¥ç©ºé—´
df -h
```

### å¦‚æœæ˜¯ Docker ç©ºé—´ä¸è¶³

```bash
# ä½¿ç”¨ç´§æ€¥æ¸…ç†è„šæœ¬ï¼ˆæ¨èï¼‰
./scripts/docker/emergency-cleanup.sh

# æˆ–æ‰‹åŠ¨æ¸…ç†
docker builder prune -af
docker image prune -af
docker system prune -af
```

### å¦‚æœæ˜¯ Docker Desktop é™åˆ¶

```bash
# 1. æ‰“å¼€ Docker Desktop
# 2. Settings â†’ Resources â†’ Advanced
# 3. å¢åŠ  Disk image size
# 4. Apply & Restart
```

## ğŸ“Š ç©ºé—´ä½¿ç”¨å‚è€ƒ

### æ­£å¸¸æƒ…å†µ

| é¡¹ç›® | ä½¿ç”¨ç‡ | çŠ¶æ€ |
|------|--------|------|
| ä¸»æœºæ ¹åˆ†åŒº | < 80% | âœ… æ­£å¸¸ |
| Docker æ•°æ®åˆ†åŒº | < 80% | âœ… æ­£å¸¸ |
| Inode | < 80% | âœ… æ­£å¸¸ |
| Docker æ„å»ºç¼“å­˜ | < 2GB | âœ… æ­£å¸¸ |

### éœ€è¦æ³¨æ„

| é¡¹ç›® | ä½¿ç”¨ç‡ | çŠ¶æ€ | å»ºè®® |
|------|--------|------|------|
| ä¸»æœºæ ¹åˆ†åŒº | 80-90% | âš ï¸ æ³¨æ„ | å‡†å¤‡æ¸…ç† |
| Docker æ•°æ®åˆ†åŒº | 80-90% | âš ï¸ æ³¨æ„ | æ¸…ç† Docker ç¼“å­˜ |
| Inode | 80-90% | âš ï¸ æ³¨æ„ | åˆ é™¤å°æ–‡ä»¶ |

### éœ€è¦ç«‹å³å¤„ç†

| é¡¹ç›® | ä½¿ç”¨ç‡ | çŠ¶æ€ | è¡ŒåŠ¨ |
|------|--------|------|------|
| ä¸»æœºæ ¹åˆ†åŒº | > 90% | ğŸ”´ å±é™© | ç«‹å³æ¸…ç†æˆ–æ‰©å®¹ |
| Docker æ•°æ®åˆ†åŒº | > 90% | ğŸ”´ å±é™© | ç«‹å³æ¸…ç† Docker |
| Inode | > 90% | ğŸ”´ å±é™© | ç«‹å³åˆ é™¤æ–‡ä»¶ |

## ğŸ”§ é¢„é˜²æªæ–½

### 1. å®šæœŸç›‘æ§

```bash
# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©æ£€æŸ¥ï¼‰
0 2 * * * /path/to/scripts/docker/diagnose-space.sh >> /var/log/docker-space-check.log 2>&1
```

### 2. è‡ªåŠ¨æ¸…ç†ï¼ˆDockerï¼‰

```bash
# æ¯å‘¨æ¸…ç† Docker æ„å»ºç¼“å­˜
0 3 * * 0 docker builder prune -af --filter "until=168h"
```

### 3. è®¾ç½®å‘Šè­¦

å¦‚æœä½¿ç”¨ç›‘æ§ç³»ç»Ÿï¼Œè®¾ç½®å‘Šè­¦ï¼š
- ç£ç›˜ä½¿ç”¨ç‡ > 85%
- Docker ç¼“å­˜ > 5GB
- Inode ä½¿ç”¨ç‡ > 85%

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Docker ç©ºé—´ç´§æ€¥ä¿®å¤](./DOCKER_SPACE_EMERGENCY_FIX.md)
- [Docker æ„å»ºé—®é¢˜æ’æŸ¥](./DOCKER_BUILD_TROUBLESHOOTING.md)
- [éƒ¨ç½²è„šæœ¬ä½¿ç”¨è¯´æ˜](./DEPLOYMENT_SCRIPT_USAGE.md)

## âœ… æ€»ç»“

**å¦‚ä½•åˆ¤æ–­æ˜¯ä¸»æœºç©ºé—´è¿˜æ˜¯ Docker ç©ºé—´ä¸è¶³ï¼Ÿ**

1. **è¿è¡Œè¯Šæ–­è„šæœ¬**ï¼š
   ```bash
   ./scripts/docker/diagnose-space.sh
   ```

2. **æŸ¥çœ‹è¯Šæ–­ç»“æœ**ï¼š
   - å¦‚æœä¸»æœºæ ¹åˆ†åŒºä½¿ç”¨ç‡ > 90% â†’ **ä¸»æœºç©ºé—´ä¸è¶³**
   - å¦‚æœ Docker æ•°æ®åˆ†åŒºä½¿ç”¨ç‡ > 90% â†’ **Docker ç©ºé—´ä¸è¶³**
   - å¦‚æœä½¿ç”¨ Docker Desktop â†’ **æ£€æŸ¥ç£ç›˜é•œåƒå¤§å°é™åˆ¶**

3. **æ ¹æ®ç»“æœæ‰§è¡Œç›¸åº”çš„æ¸…ç†æ“ä½œ**

**å¿«é€Ÿä¿®å¤**ï¼š
- ä¸»æœºç©ºé—´ä¸è¶³ â†’ æ¸…ç†ç³»ç»Ÿæ—¥å¿—å’Œ apt ç¼“å­˜
- Docker ç©ºé—´ä¸è¶³ â†’ `./scripts/docker/emergency-cleanup.sh`
- Docker Desktop â†’ å¢åŠ ç£ç›˜é•œåƒå¤§å°

